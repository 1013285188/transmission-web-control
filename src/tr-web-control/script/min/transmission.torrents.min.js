transmission.torrents={all:null,puased:null,downloading:null,actively:null,searchResult:null,error:null,warning:null,folders:{},status:{},count:0,totalSize:0,loadSimpleInfo:!1,activeTorrentCount:0,pausedTorrentCount:0,fields:{base:"id,name,status,hashString,totalSize,percentDone,addedDate,trackerStats,leftUntilDone,rateDownload,rateUpload,recheckProgress,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,downloadDir,error,errorString,doneDate,queuePosition,activityDate",
status:"id,status,percentDone,trackerStats,leftUntilDone,rateDownload,rateUpload,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,error,errorString,doneDate,queuePosition,activityDate",config:"downloadLimit,downloadLimited,peer-limit,seedIdleLimit,seedIdleMode,seedRatioLimit,seedRatioMode,uploadLimit,uploadLimited"},datas:{},recently:null,removed:null,isRecentlyActive:!1,newIds:[],btItems:[],getallids:function(b,e,c){var a=this.fields.base;this.loadSimpleInfo&&
this.all&&(a=this.fields.status);a=a.split(",");$.isArray(c)&&$.unique($.merge(a,c));c={fields:a};this.isRecentlyActive=!1;this.all&&void 0==e?(c.ids="recently-active",this.isRecentlyActive=!0):e&&(c.ids=e);this.all||(this.all={});transmission.exec({method:"torrent-get",arguments:c},function(a){"success"==a.result?(transmission.torrents.newIds.length=0,transmission.torrents.loadSimpleInfo=!0,transmission.torrents.recently=a.arguments.torrents,transmission.torrents.removed=a.arguments.removed,transmission.torrents.splitid(),
b&&b(a.arguments.torrents)):(transmission.torrents.datas=null,b&&b(null))})},splitid:function(){this.downloading=[];this.puased=[];this.actively=[];this.error=[];this.warning=[];this.btItems=[];transmission.downloadDirs=[];var b=transmission._status;this.status={};transmission.trackers={};this.totalSize=0;this.folders={};this.count=0;var e=new Base64,c;for(c in this.recently){var a=this.recently[c];this.datas[a.id]=a}var g=[];for(c in this.removed)a=this.removed[c],g.push(a);for(c in this.datas){a=
this.datas[c];if(!a)return;if(-1!=$.inArray(a.id,g)&&0<g.length)this.all[a.id]&&(this.all[a.id]=null,delete this.all[a.id]),this.datas[c]=null,delete this.datas[c];else{this.isRecentlyActive&&!this.all[a.id]&&this.newIds.push(a.id);a=$.extend(this.all[a.id],a);0==a.uploadedEver&&0==a.downloadedEver&&(a.uploadRatio="\u221e");a.infoIsLoading=!1;var d=this.status[a.status];this.addTracker(a);d||(this.status[a.status]=[],d=this.status[a.status]);this.totalSize+=a.totalSize;0<a.rateDownload&&0<a.leftUntilDone?
(a.remainingTime=getTotalTime(a.leftUntilDone/a.rateDownload*1E3),a.remainingTimeRaw=Math.floor(a.leftUntilDone/a.rateDownload*1E3)):0==a.rateDownload&&0==a.leftUntilDone&&0!=a.totalSize?(a.remainingTime=0,a.remainingTimeRaw=0):(a.remainingTime="\u221e",a.remainingTimeRaw=31536E8);d.push(a);0!=a.error&&this.error.push(a);(0<a.rateUpload||0<a.rateDownload)&&this.actively.push(a);switch(a.status){case b.stopped:this.puased.push(a);break;case b.download:this.downloading.push(a)}this.all[a.id]=a;-1==
$.inArray(a.downloadDir,transmission.downloadDirs)&&transmission.downloadDirs.push(a.downloadDir);if(transmission.options.getFolders&&a.downloadDir){d=a.downloadDir.split("/");var l="folders-",h;for(h in d){var f=d[h];""!=f&&(l+=e.encode(f),(f=this.folders[l])||(f={count:0,torrents:[],size:0,nodeid:l}),f.torrents.push(a),f.count++,f.size+=a.totalSize,this.folders[l]=f)}}this.count++}}transmission.downloadDirs=transmission.downloadDirs.sort();0<this.newIds.length&&this.getallids(null,this.newIds)},
addTracker:function(b){var e=b.trackerStats,c=!1,a=[];b.leecherCount=0;b.seederCount=0;if(0<e.length){for(var g in e){var d=e[g],l=d.lastAnnounceResult.toLowerCase(),h=d.host.getHostName().split(".");-1!=$.inArray(h[0],["www","tracker"])&&h.shift();h=h.join(".");var f="tracker-"+h.replace(/\./g,"-"),k=transmission.trackers[f];k||(transmission.trackers[f]={count:0,torrents:[],size:0,connected:!0,isBT:5<e.length},k=transmission.trackers[f]);k.name=h;k.nodeid=f;k.host=d.host;d.lastAnnounceSucceeded||
d.announceState==transmission._trackerStatus.inactive||(c=!0,b.warning=d.lastAnnounceResult,"could not connect to tracker"==l&&(k.connected=!1));-1==k.torrents.indexOf(b)&&(k.torrents.push(b),k.count++,k.size+=b.totalSize);b.leecherCount+=d.leecherCount;b.seederCount+=d.seederCount;-1==a.indexOf(h)&&a.push(h)}5<e.length&&this.btItems.push(b);c&&(b.nextAnnounceTime?b.nextAnnounceTime>d.nextAnnounceTime&&(b.nextAnnounceTime=d.nextAnnounceTime):b.nextAnnounceTime=d.nextAnnounceTime,this.warning.push(b));
0>b.leecherCount&&(b.leecherCount=0);0>b.seederCount&&(b.seederCount=0);b.leecher=b.leecherCount+" ("+b.peersGettingFromUs+")";b.seeder=b.seederCount+" ("+b.peersSendingToUs+")";b.trackers=a.join(";")}},getPeers:function(b){transmission.exec({method:"torrent-get",arguments:{fields:["peers","peersFrom"],ids:b}},function(b){console.log("data:",b)})},getMoreInfos:function(b,e,c){transmission.exec({method:"torrent-get",arguments:{fields:b.split(","),ids:e}},function(a){"success"==a.result?c&&c(a.arguments.torrents):
c&&c(null)})},search:function(b,e){if(!b)return null;e||(e=this.all);var c=[];$.each(e,function(a,g){-1!=e[a].name.toLowerCase().indexOf(b.toLowerCase())&&c.push(e[a])});return this.searchResult=c},getFiles:function(b,e){transmission.exec({method:"torrent-get",arguments:{fields:["files","fileStats"],ids:b}},function(b){"success"==b.result?e&&e(b.arguments.torrents):e&&e(null)})},getConfig:function(b,e){this.getMoreInfos(this.fields.config,b,e)},getErrorIds:function(b,e){var c=[],a=new Date;1==e&&
(a=a.getTime()/1E3);for(var g in this.error){var d=this.error[g];-1!=$.inArray(d.id,b)&&0<b.length||1==e&&a<d.nextAnnounceTime||d.status!=transmission._status.stopped&&c.push(d.id)}for(g in this.warning)d=this.warning[g],-1!=$.inArray(d.id,b)&&0<b.length||1==e&&a<d.nextAnnounceTime||c.push(d.id);return c},searchAndReplaceTrackers:function(b,e,c){if(b&&e){var a={},g=0,d;for(d in this.all){var l=this.all[d];if(!l)return;var h=l.trackerStats,f;for(f in h)h[f].announce==b&&(a[f]||(a[f]={ids:[],tracker:e}),
a[f].ids.push(l.id),g++)}0==g&&c&&c(null,0);for(d in a)transmission.exec({method:"torrent-set",arguments:{ids:a[d].ids,trackerReplace:[parseInt(d),a[d].tracker]}},function(a,b){"success"==a.result?c&&c(b,g):c&&c(null)},a[d].ids)}}};
